name: Nightly Benchmark

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      gluten_commit:
        description: 'Gluten commit SHA (optional, defaults to latest main)'
        required: false
      spark_version:
        description: 'Spark version'
        required: false
        default: '3.5.5'

env:
  JAVA_VERSION: '17'
  SBT_VERSION: '1.9.8'

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        spark: ['3.4.4', '3.5.5', '4.0.1']
      fail-fast: false

    steps:
      - name: Checkout benchmark repo
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache sbt
        uses: actions/cache@v4
        with:
          path: |
            ~/.sbt
            ~/.ivy2/cache
            ~/.cache/coursier
          key: sbt-${{ hashFiles('build.sbt', 'project/build.properties') }}

      - name: Get Gluten commit info
        id: gluten
        run: |
          if [ -n "${{ inputs.gluten_commit }}" ]; then
            echo "sha=${{ inputs.gluten_commit }}" >> $GITHUB_OUTPUT
          else
            SHA=$(curl -sL https://api.github.com/repos/apache/incubator-gluten/commits/main | jq -r '.sha')
            echo "sha=$SHA" >> $GITHUB_OUTPUT
          fi
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Download Gluten JAR
        run: |
          # Extract major.minor version (e.g., 3.5.5 -> 3.5)
          SPARK_MAJOR_MINOR=$(echo "${{ matrix.spark }}" | sed 's/\([0-9]*\.[0-9]*\)\..*/\1/')
          SPARK_VERSION=$SPARK_MAJOR_MINOR ./scripts/download-gluten-nightly.sh

      - name: Run benchmarks
        env:
          SPARK_GENERATE_BENCHMARK_FILES: '1'
          SPARK_BENCHMARK_DATE: ${{ steps.gluten.outputs.date }}
        run: |
          ./build/sbt -Dspark.version=${{ matrix.spark }} \
              "runMain org.apache.gluten.benchmark.RunAllBenchmarks"

      - name: List results
        run: |
          echo "Results saved to:"
          find benchmarks -name "*.txt" -type f

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-spark-${{ matrix.spark }}-${{ steps.gluten.outputs.date }}
          path: benchmarks/

  compare:
    needs: benchmark
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: downloaded-results/
          pattern: benchmark-results-*
          merge-multiple: true

      - name: Merge and compare results
        run: |
          # Merge downloaded results into benchmarks/
          cp -r downloaded-results/* benchmarks/ 2>/dev/null || true
          
          echo "=== Benchmark Results ==="
          ./scripts/compare-daily.sh 7 || true

      - name: Commit results (if on main)
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add benchmarks/
          git diff --staged --quiet || git commit -m "Daily benchmark results $(date +%Y-%m-%d)"
          git push || echo "Push failed - may need manual intervention"
