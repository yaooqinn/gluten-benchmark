name: Nightly Benchmark

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      gluten_commit:
        description: 'Gluten commit SHA (optional, defaults to latest main)'
        required: false
      spark_version:
        description: 'Spark version'
        required: false
        default: '3.5.5'
      benchmark_mode:
        description: 'Benchmark mode: quick (fewer iterations) or full'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - full
      benchmark_suite:
        description: 'Specific suite to run (empty for all)'
        required: false
        default: ''

env:
  JAVA_VERSION: '17'
  SBT_VERSION: '1.9.8'

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    strategy:
      matrix:
        # Run 3.5.5 daily, all versions on manual trigger
        spark: ${{ github.event_name == 'schedule' && fromJSON('["3.5.5"]') || fromJSON('["3.4.4", "3.5.5", "4.0.0"]') }}
        # Split benchmarks across parallel jobs for speed
        suite: ['aggregate', 'string', 'map', 'explode', 'higherorder', 'array']
      fail-fast: false
      max-parallel: 6

    steps:
      - name: Checkout benchmark repo
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache sbt
        uses: actions/cache@v4
        with:
          path: |
            ~/.sbt
            ~/.ivy2/cache
            ~/.cache/coursier
          key: sbt-${{ hashFiles('build.sbt', 'project/build.properties') }}

      - name: Get Gluten commit info
        id: gluten
        run: |
          if [ -n "${{ inputs.gluten_commit }}" ]; then
            echo "sha=${{ inputs.gluten_commit }}" >> $GITHUB_OUTPUT
          else
            SHA=$(curl -sL https://api.github.com/repos/apache/incubator-gluten/commits/main | jq -r '.sha')
            echo "sha=$SHA" >> $GITHUB_OUTPUT
          fi
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Download Gluten JAR
        run: |
          SPARK_MAJOR_MINOR=$(echo "${{ matrix.spark }}" | sed 's/\([0-9]*\.[0-9]*\)\..*/\1/')
          SPARK_VERSION=$SPARK_MAJOR_MINOR ./scripts/download-gluten-nightly.sh

      - name: Map suite name to class
        id: suite
        run: |
          case "${{ matrix.suite }}" in
            aggregate) CLASS="AggregateBenchmark" ;;
            string) CLASS="StringFunctionsBenchmark" ;;
            map) CLASS="MapFunctionsBenchmark" ;;
            explode) CLASS="ExplodeBenchmark" ;;
            higherorder) CLASS="HigherOrderFunctionsBenchmark" ;;
            array) CLASS="ArrayFunctionsBenchmark" ;;
            *) CLASS="" ;;
          esac
          echo "class=$CLASS" >> $GITHUB_OUTPUT

      - name: Run benchmark suite
        env:
          SPARK_GENERATE_BENCHMARK_FILES: '1'
          SPARK_BENCHMARK_DATE: ${{ steps.gluten.outputs.date }}
          # Quick mode: fewer iterations
          BENCHMARK_WARMUP_ITERS: ${{ inputs.benchmark_mode == 'full' && '5' || '2' }}
          BENCHMARK_ITERS: ${{ inputs.benchmark_mode == 'full' && '5' || '3' }}
        run: |
          FILTER="${{ inputs.benchmark_suite || steps.suite.outputs.class }}"
          # Use fast runner for better session reuse
          ./build/sbt -Dspark.version=${{ matrix.spark }} \
              -Dbenchmark.warmup.iters=${BENCHMARK_WARMUP_ITERS:-2} \
              -Dbenchmark.iters=${BENCHMARK_ITERS:-3} \
              "runMain org.apache.gluten.benchmark.RunAllBenchmarksFast $FILTER"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.suite }}-spark-${{ matrix.spark }}-${{ steps.gluten.outputs.date }}
          path: benchmarks/
          retention-days: 30

  merge-results:
    needs: benchmark
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: downloaded-results/
          pattern: benchmark-*
          merge-multiple: true

      - name: Merge results
        run: |
          mkdir -p benchmarks
          cp -r downloaded-results/* benchmarks/ 2>/dev/null || true
          
          echo "=== Benchmark Results ==="
          find benchmarks -name "*.txt" -type f | head -20
          
          # Generate summary
          echo "## Benchmark Summary - $(date +%Y-%m-%d)" > benchmarks/SUMMARY.md
          echo "" >> benchmarks/SUMMARY.md
          for f in benchmarks/**/*.txt; do
            if [ -f "$f" ]; then
              echo "### $(basename $f .txt)" >> benchmarks/SUMMARY.md
              head -50 "$f" >> benchmarks/SUMMARY.md
              echo "" >> benchmarks/SUMMARY.md
            fi
          done

      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-merged-${{ needs.benchmark.outputs.date || 'latest' }}
          path: benchmarks/

      - name: Commit results (if on main)
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add benchmarks/
          git diff --staged --quiet || git commit -m "Benchmark results $(date +%Y-%m-%d) [${{ github.event_name }}]"
          git push || echo "Push failed - may need manual intervention"
